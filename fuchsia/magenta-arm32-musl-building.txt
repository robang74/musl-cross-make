#!/usr/bin/env bash

mkdir -p fuchsia
popd fuchsia
git clone https://github.com/robang74/musl-cross-make
pushd musl-cross-make
cat fuchsia/config.mak >config.mak
if make -j$(nproc) install >make.log; then
	tail -n10 make.log
else
	tail -f -n10 make.log
fi
popd

TCBIN_PATH=$PWD/toolchain/bin
export PATH=$TCBIN_PATH:$PATH
export ARCH_arm_TOOLCHAIN_PREFIX=$(basename $TCBIN_PATH/arm*gcc | sed -e "s/gcc$//")
echo ARCH_arm_TOOLCHAIN_PREFIX=$ARCH_arm_TOOLCHAIN_PREFIX

git clone https://fuchsia.googlesource.com/magenta
pushd magenta
if make -j$(nproc) magenta-qemu-arm32 >make.log; then
	tail -n10 make.log
else
	tail -f -n10 make.log
fi
popd

git clone https://fuchsia.googlesource.com/third_party/qemu
pushd qemu
git checkout fuchsia
INST_PATH=$PWD/../qemu-runtime
./configure --target-list=arm-softmmu --prefix=$INST_PATH
# This compilation on Ubuntu 14.04 depends by libtool (deprecated)
if make -j$(nproc) install >make.log; then
	tail -n10 make.log
else
	tail -f -n10 make.log
fi
export PATH=$INST_PATH/bin:$PATH
popd

pushd magenta/build-magenta-qemu-arm32
qemu-system-arm -m 64 -nographic -machine virt -cpu cortex-a15 -kernel magenta.elf

